<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>KHY Stage Game (Modularized)</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
</head>
<body>
  <!-- === Error Overlay (mobile-friendly) === -->
  <div id="bootError" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.85);color:#ffb4b4;font:14px ui-monospace,Menlo,Consolas,monospace;padding:16px;overflow:auto">
    <div style="max-width:900px;margin:auto">
      <h3 style="margin:0 0 8px;color:#fecaca">Error</h3>
      <pre id="bootErrorMsg" style="white-space:pre-wrap"></pre>
      <button style="margin-top:12px;padding:8px 12px;background:#1f2937;color:#fff;border:1px solid #374151;border-radius:8px" onclick="this.closest('#bootError').style.display='none'">Dismiss</button>
    </div>
  </div>
  <script>
    window.addEventListener('error', (e)=>{
      const b=document.getElementById('bootError'), m=document.getElementById('bootErrorMsg');
      if(b&&m){ m.textContent=(e.message||'Unknown error')+'\n'+(e.filename?e.filename+':'+e.lineno:''); b.style.display='block'; }
    });
  </script>

  <div class="entry-overlay" id="entryOverlay" role="dialog" aria-modal="true" aria-labelledby="entryTitle">
    <div class="entry-card">
      <h1 id="entryTitle">SoK Empire Toolkit</h1>
      <p class="entry-subtitle">Choose which experience you want to open.</p>
      <div class="entry-actions">
        <button type="button" id="entryLaunchGame" class="entry-btn entry-btn--primary">Launch Game Demo</button>
        <a id="entryOpenEditor" class="entry-btn entry-btn--ghost" href="./cosmetic-editor.html">Open Cosmetic Editor</a>
      </div>
      <label class="entry-remember">
        <input type="checkbox" id="entryRememberChoice">
        <span>Remember this choice for next time</span>
      </label>
    </div>
  </div>

  <main class="stack">
    <section class="widget widget--clear">
      <div class="stage" id="gameStage">
        <canvas id="game" width="720" height="460" aria-label="Stick figure canvas"></canvas>

        <!-- HUD: health / stamina / footing -->
        <div class="health-bar">
          <div class="health-fill" id="healthFill"></div>
          <div class="health-label" id="healthLabel">HP: 100</div>
        </div>
        <div class="stamina-bar">
          <div class="stamina-fill" id="staminaFill"></div>
          <div class="stamina-label" id="staminaLabel">STAMINA</div>
        </div>
        <div class="footing-bar">
          <div class="footing-fill" id="footingFill"></div>
          <div class="footing-label" id="footingLabel">FOOTING</div>
        </div>

        <!-- Door Interaction Prompt -->
        <div class="interact-prompt" id="interactPrompt">Press E to Enter</div>

        <!-- Transition Overlay + area name -->
        <div class="transition-overlay" id="transitionOverlay"></div>
        <div class="area-name" id="areaName"></div>

        <!-- Controls overlay -->
        <div class="controls-overlay">
          <div class="top-ui">
            <button type="button" id="btnHelp" class="ui-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="helpPanel">‚ùì Help</button>
            <button type="button" id="btnFullscreen" class="ui-btn">‚§¢ Full</button>
            <button type="button" id="btnReloadCfg" class="ui-btn">‚Üª Config</button>
            <button type="button" id="debugToggle" class="ui-btn">üîç Debug</button>
          </div>

          <div class="help-panel" id="helpPanel" role="dialog" aria-modal="false" aria-label="On-screen control help">
            <h4>Controls</h4>
            <div><span class="key">Joystick</span> - Move & Aim</div>
            <div><span class="key">Green</span> - Jump</div>
            <div><span class="key">Red</span> - Attack A (Combo)</div>
            <div><span class="key">Orange</span> - Attack B (Quick)</div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #444;">
              <span class="key">Keyboard:</span> WASD move, E/F attack
            </div>
          </div>

          <!-- Virtual Joystick -->
          <div class="joystick-area" id="joystickArea">
            <div class="joystick-base"></div>
            <div class="joystick-stick" id="joystickStick"></div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button type="button" id="btnJump" class="action-btn jump">‚Üë</button>
            <button type="button" id="btnAttackA" class="action-btn attack-a">A</button>
            <button type="button" id="btnAttackB" class="action-btn attack-b">B</button>
          </div>

          <!-- Interact Button -->
          <button type="button" id="btnInteract" class="interact-btn">E</button>
        </div>
      </div>

      <div id="aiHud" style="position:absolute; top:8px; left:8px; z-index:50; padding:6px 8px; background:rgba(10,10,14,.7); color:#7dd3fc; font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border:1px solid rgba(125,211,252,.3); border-radius:8px; display:none; pointer-events:none;">
        NPC HUD
      </div>
      <div id="fpsHud" style="position:absolute; top:8px; right:8px; z-index:50; padding:6px 8px; background:rgba(10,10,14,.7); color:#d1fae5; font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border:1px solid rgba(16,185,129,.35); border-radius:8px; pointer-events:none;">
        FPS: --
      </div>
    </section>

    <section class="widget">
      <div class="settings" id="settingsGrid">
        <div class="box" id="appSettingsBox">
          <div class="label">App Settings</div>
          <div class="fields">
            <label>Character <select id="characterSelect"></select></label>
            <label>Fighter <select id="fighterSelect"></select></label>
            <label>Weapon <select id="weaponSelect"></select></label>
            <div class="ability-slot-group" data-slot="A">
              <div class="ability-slot-title">Slot A</div>
              <label>Light <select id="slotALight"></select></label>
              <label>Heavy <select id="slotAHeavy"></select></label>
            </div>
            <div class="ability-slot-group" data-slot="B">
              <div class="ability-slot-title">Slot B</div>
              <label>Light <select id="slotBLight"></select></label>
              <label>Heavy <select id="slotBHeavy"></select></label>
            </div>
            <label>Character scale <input id="actorScale" type="range" min="0.50" max="1.10" step="0.02" value="0.70"></label>
            <label>Ground height <input id="groundRatio" type="range" min="0.60" max="0.92" step="0.01" value="0.70"></label>
            <label>Hand collider size <input id="handMultiplier" type="range" min="1.0" max="4.0" step="0.1" value="2.0"></label>
            <label>Foot collider size <input id="footMultiplier" type="range" min="0.5" max="2.0" step="0.1" value="1.0"></label>
            <label>Authored weight <input id="wAuth" type="range" min="0" max="1" step="0.05" value="0.6"></label>
            <label>Physics weight <input id="wPhys" type="range" min="0" max="1" step="0.05" value="0.4"></label>
            <label class="row">Calves-only IK <input id="ikCalvesOnly" type="checkbox" checked style="margin-left:auto;"></label>
            <label class="row">Facing locks during attack <input id="lockFacing" type="checkbox" checked style="margin-left:auto;"></label>
          </div>
          <div class="row" style="margin-top:6px;">
            <span class="pill">Walk overwrites Stance + lerps back</span>
            <span class="pill">Flip on direction (initial press)</span>
            <span class="pill">Calf ragdoll mid-air (non-attack)</span>
          </div>
        </div>
        <div class="box" id="statusBox">
          <div class="label">Game Status</div>
          <div id="statusInfo" style="font-size: 12px; color: #86efac;">
            Booting‚Ä¶
          </div>
        </div>

        <div class="box" id="fighterSettingsBox" style="display: none;">
          <div class="label fighter-settings-label">
            Fighter Settings
            <button type="button" id="toggleFighterSettings" class="toggle-btn">‚ñº</button>
          </div>
          <div id="fighterSettingsContent" class="fighter-settings-content">
            <div id="fighterSettingsFields" class="fields"></div>
            <div class="fighter-settings-buttons">
              <button type="button" id="btnRefreshFighter" class="fighter-btn" title="Revert all changes to the values currently loaded from config.js">‚Üª Refresh</button>
              <button type="button" id="btnLoadFighter" class="fighter-btn fighter-btn--primary" title="Apply edited values to the running game and reload fighter (sprites/skeleton)">‚ñ∂ Load</button>
              <button type="button" id="btnReinitializeFighter" class="fighter-btn" title="Reload fighter sprites and skeleton while preserving all current settings and edits">üîÑ Reinitialize</button>
              <button type="button" id="btnExportConfig" class="fighter-btn" title="Download the current config as config.js file for upload to repository">‚¨á Export</button>
            </div>
          </div>
        </div>

        <div class="box" id="skeletonKeyBox">
          <div class="label">Skeleton Debug Key</div>
          <div id="boneKeyList" class="fields" style="gap: 6px;"></div>
        </div>

        <div class="box" id="renderDebugBox">
          <div class="label">Render Debug Controls</div>
          <div class="fields">
            <label class="row">Show Sprites <input id="toggleShowSprites" type="checkbox" checked style="margin-left:auto;"></label>
            <label class="row">Show Bones <input id="toggleShowBones" type="checkbox" checked style="margin-left:auto;"></label>
            <label class="row">Show Hitbox <input id="toggleShowHitbox" type="checkbox" checked style="margin-left:auto;"></label>
          </div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(148,163,184,0.2);">
            Toggle rendering layers independently for debugging
          </div>
        </div>

        <div class="box" id="comboBox">
          <div class="label">Combo Settings</div>
          <div id="comboFields" class="fields"></div>
        </div>

        <div class="box" id="hitBox">
          <div class="label">Manual Hit Count</div>
          <input id="hitSlider" type="range" min="0" max="4" step="1" value="0" style="width: 100%;">
        </div>
      </div>
    </section>

    <!-- Debug Panel -->
    <section class="widget debug-panel debug-panel--hidden" id="debugPanel">
      <div class="debug-panel-header">
        <div class="label" style="font-size: 14px; font-weight: 600;">üîç Debug Panel</div>
        <button type="button" id="debugCopyJson" class="debug-copy-btn">üìã Copy JSON</button>
      </div>

      <div class="debug-panel-controls">
        <label class="debug-checkbox-label" title="When checked, manual joint angle edits persist without being overwritten by animation or lerping">
          <input type="checkbox" id="freezeAnglesCheckbox" />
          <span>üîí Freeze Joint Angles After Editing</span>
        </label>
      </div>

      <div class="debug-panel-content">
        <div class="debug-column">
          <div id="debugTransforms">
            <!-- Transforms will be populated by JavaScript -->
          </div>
        </div>

        <div class="debug-column">
          <div id="debugPoseEditor">
            <!-- Pose editor will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const overlay = document.getElementById('entryOverlay');
      if (!overlay) return;

      const params = new URLSearchParams(window.location.search);
      const defaultMode = params.get('mode');
      const skipKey = 'sok-entry-mode';
      const remembered = localStorage.getItem(skipKey);
      const defaultMode = params.get('mode') || remembered;

      const hideOverlay = () => {
        overlay.classList.add('entry-overlay--hidden');
        setTimeout(() => overlay.remove(), 400);
      };

      if (defaultMode === 'game') {
        hideOverlay();
        return;
      }

      if (defaultMode === 'editor') {
        window.location.href = './cosmetic-editor.html';
        return;
      }

      const launchBtn = document.getElementById('entryLaunchGame');

      launchBtn?.addEventListener('click', () => {
      const rememberCheckbox = document.getElementById('entryRememberChoice');

      if (remembered === 'game') {
        rememberCheckbox.checked = true;
      }

      launchBtn?.addEventListener('click', () => {
        if (rememberCheckbox?.checked) {
          localStorage.setItem(skipKey, 'game');
        } else {
          localStorage.removeItem(skipKey);
        }
        hideOverlay();
      });

      const editorLink = document.getElementById('entryOpenEditor');
      editorLink?.addEventListener('click', () => {
        /* no-op */
        if (rememberCheckbox?.checked) {
          localStorage.setItem(skipKey, 'editor');
        } else {
          localStorage.removeItem(skipKey);
        }
      });
    })();
  </script>

  <!-- In-repo config served same-origin under /docs -->
  <script src="./config/config.js"></script>
  <script type="module" src="./js/cosmetic-library.js?v=1"></script>
  <script type="module" src="./js/cosmetic-profiles.js?v=1"></script>
  <script type="module" src="./js/app.js?v=19"></script>
</body>
</html>
