<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Map Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <style>
    :root {
      --bg:#05070a; --panel:#10141a; --card:#151b22;
      --line:#27303c; --muted:#7f8ea3; --text:#e6edf3;
      --btn:#1a2330; --btnHi:#222d3c;
    }
    * { box-sizing:border-box; }

    html, body {
      margin:0;
      padding:0;
      height:100%;
      min-height:100vh;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;
      padding-left:env(safe-area-inset-left);
      padding-right:env(safe-area-inset-right);
      padding-bottom:env(safe-area-inset-bottom);
    }

    #app {
      display:flex;
      flex-direction:column;
      min-height:100vh;
      background:var(--bg);
    }

    header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:12px 14px 8px;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      gap:8px;
      flex-wrap:wrap;
      font-size:11px;
    }
    
    header h1 {
      margin:0;
      font-size:16px;
      font-weight:600;
      color:var(--text);
    }

    .content {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:40px 20px;
    }

    .info-box {
      background:var(--card);
      border:1px solid var(--line);
      border-radius:8px;
      padding:24px;
      max-width:600px;
      text-align:center;
    }

    .info-box h2 {
      margin:0 0 16px;
      color:var(--text);
    }

    .info-box p {
      margin:0 0 16px;
      color:var(--muted);
      line-height:1.6;
    }

    .info-box h3 {
      margin:24px 0 12px;
      color:var(--text);
      font-size:16px;
    }

    .info-box ul {
      margin:0 0 16px;
      padding-left:24px;
      color:var(--muted);
    }

    .info-box li {
      margin:4px 0;
      line-height:1.5;
    }

    .info-box code {
      background:var(--btn);
      padding:2px 6px;
      border-radius:3px;
      font-size:12px;
      color:var(--text);
    }

    .info-box a {
      color:#1a7f64;
      text-decoration:underline;
    }

    .info-box a:hover {
      color:#2a9f84;
    }

    .btn-group {
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .btn {
      padding:10px 20px;
      background:var(--btn);
      color:var(--text);
      border:1px solid var(--line);
      border-radius:6px;
      font-size:14px;
      font-weight:500;
      text-decoration:none;
      cursor:pointer;
      transition:background 0.2s;
    }

    .btn:hover {
      background:var(--btnHi);
    }

    .btn-primary {
      background:#1a7f64;
      border-color:#1a7f64;
    }

    .btn-primary:hover {
      background:#2a9f84;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>3D Map Builder</h1>
    </header>
    <div class="content">
      <div class="info-box">
        <h2>3D Map Builder</h2>
        <p>
          This is the primary interface for creating 3D visual maps using the grid-based 
          editor with real-time 3D preview. Visual map data is stored in 
          <code>/config/maps/visualsmaps</code> as structured JSON files.
        </p>
        
        <h3>Getting Started</h3>
        <p>
          The 3D map builder uses a grid-based workflow where you place ground segments 
          (roads, sidewalks) and structures (buildings, props) on a 20x20 grid. The editor 
          provides a real-time 3D preview using Three.js and exports to a JSON format that 
          can be consumed by the game runtime.
        </p>
        
        <h3>Visual Map Storage</h3>
        <p>
          Visual maps are stored in <code>/config/maps/visualsmaps/</code> directory:
        </p>
        <ul style="text-align: left; max-width: 500px; margin: 0 auto 16px;">
          <li><strong>index.json</strong> - Catalog of available assets (segments, structures)</li>
          <li><strong>*_visualsmap.json</strong> - Individual map files with grid state and asset references</li>
        </ul>
        
        <h3>Importing Ground Segments (glTF)</h3>
        <p>
          Ground segments and structures are stored as glTF/GLB files in:
        </p>
        <ul style="text-align: left; max-width: 500px; margin: 0 auto 16px;">
          <li><code>/docs/assets/3D/ground_segments/</code> - Road, sidewalk tiles</li>
          <li><code>/docs/assets/3D/structures/</code> - Buildings, towers, props</li>
        </ul>
        <p>
          To add new assets, place the glTF file in the appropriate directory and update 
          <code>/config/maps/visualsmaps/index.json</code> with the asset definition 
          including id, label, gltfPath, baseScale, and other parameters.
        </p>
        
        <h3>Editor Features</h3>
        <ul style="text-align: left; max-width: 500px; margin: 0 auto 16px;">
          <li>Grid-based tile placement with 4-directional rotation</li>
          <li>Real-time 3D preview with Three.js</li>
          <li>Layer system (ground, structure, decoration)</li>
          <li>Per-instance scaling and offsets</li>
          <li>JSON export/import for version control</li>
          <li>Gameplay path visualization</li>
        </ul>
        
        <h3>Related Documentation</h3>
        <ul style="text-align: left; max-width: 500px; margin: 0 auto 16px;">
          <li><a href="./3d-parallel-renderer.md">3D Scene Bridge</a> - How scene3d metadata works</li>
          <li><a href="./DEPRECATED_PARALLAX_TO_3D_MIGRATION.md">Migration Guide</a> - Converting from legacy 2D parallax</li>
        </ul>
        
        <div class="btn-group">
          <a href="./map-editor.html" class="btn btn-primary">Open 3D Map Editor</a>
          <a href="./index.html" class="btn">Back to Game</a>
        </div>

        <h3 style="margin-top: 24px;">Open Built-in Visual Map</h3>
        <p style="margin-bottom: 12px;">Select a built-in visual map to open in the 3D map editor:</p>
        <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
          <select id="builtinVisualIndex" style="min-width: 250px; padding: 8px 12px; background: var(--btn); color: var(--text); border: 1px solid var(--line); border-radius: 6px; font-size: 14px;">
            <option value="">-- Loading visual maps... --</option>
          </select>
          <button id="btnOpenBuiltinVisual" class="btn btn-primary" style="min-width: 250px;" disabled>Open in 3D Map Editor</button>
          <div id="fetchStatus" style="font-size: 12px; color: var(--muted); text-align: center; max-width: 400px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /**
     * 3D Map Builder
     * 
     * This module provides 3D map building functionality for creating EnvironmentMap data
     * that complements the GameplayMap collision and interaction data from the 2D editor.
     * 
     * Integration Points:
     * - EnvironmentMap Format: Exported from map editor with gridUnitSize and 3D geometry data
     * - Three.js: Used for 3D preview and model manipulation (loaded from CDN)
     * - Map Runtime: Integrates with docs/js/vendor/map-runtime.js for area loading
     * 
     * Features to Implement:
     * - 3D model placement and manipulation
     * - Procedural geometry generation
     * - Lighting and material editing
     * - Import/Export EnvironmentMap format
     * - Integration with GRID_UNIT_WORLD_SIZE from docs/config/config.js
     * 
     * See also:
     * - docs/map-editor.html (2D map editor with EnvironmentMap export)
     * - docs/config/config.js (GRID_UNIT_WORLD_SIZE export)
     * - Repository memories on "map editor export formats"
     */
    
    console.log('[3D Map Builder] Initialized');

    // ===== Built-in Visual Map Loading =====
    const selectElement = document.getElementById('builtinVisualIndex');
    const btnOpen = document.getElementById('btnOpenBuiltinVisual');
    const statusElement = document.getElementById('fetchStatus');

    // Check if running from file:// protocol
    function isFileProtocol() {
      return location.protocol === 'file:';
    }

    // Load visual maps index
    async function loadVisualMapsIndex() {
      if (isFileProtocol()) {
        selectElement.innerHTML = '<option value="">-- Not available (file://) --</option>';
        statusElement.textContent = 'Running from file:// â€” Please serve the docs via a local static server (e.g., python -m http.server) to use built-in map loading.';
        statusElement.style.color = '#f59e0b';
        return;
      }

      try {
        const response = await fetch('./config/maps/visualsmaps/index.json');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();

        // Populate dropdown with available maps
        selectElement.innerHTML = '<option value="">-- Select a visual map --</option>';
        if (data.maps && data.maps.length > 0) {
          data.maps.forEach(map => {
            const option = document.createElement('option');
            option.value = map.file;
            option.textContent = map.name;
            selectElement.appendChild(option);
          });
          btnOpen.disabled = false;
          statusElement.textContent = `${data.maps.length} visual map(s) available`;
          statusElement.style.color = 'var(--muted)';
        } else {
          selectElement.innerHTML = '<option value="">-- No maps found --</option>';
          statusElement.textContent = 'No visual maps found in index.json';
          statusElement.style.color = '#f59e0b';
        }
      } catch (err) {
        selectElement.innerHTML = '<option value="">-- Error loading --</option>';
        statusElement.textContent = `Error loading visual maps: ${err.message}. Using file upload may still work.`;
        statusElement.style.color = '#ef4444';
        console.error('Error loading visual maps index:', err);
      }
    }

    // Open selected map in editor
    btnOpen.addEventListener('click', () => {
      const selected = selectElement.value;
      if (!selected) {
        statusElement.textContent = 'Please select a visual map first';
        statusElement.style.color = '#f59e0b';
        return;
      }

      // Navigate to map editor with the selected file as a query parameter
      window.location.href = `./map-editor.html?load=${encodeURIComponent(selected)}`;
    });

    // Initialize
    loadVisualMapsIndex();
  </script>
</body>
</html>
